// var site_url = 'http://www.dodear.com/';
/*====== NEWS V4 STARTS HERE ======*/
( function ($) {
	$.addNews = function (d, p) {
		if (d.news) return false;

		p = $.extend({
			data : '',
			old_data : '',
			current_content : 1,

			proxy_url_base_path : 'http://',
			ftp_proxy_url_segments : '',
			
			// type
			type : 'play',		//	options avaliable --> play, static, list
			title: '',
			show_tabs: true,
			
			// controls
			contents_per_page : 3,
			total_content : 0,
			start : 1,

			playAtStart : false,
			autoplay : true,
			playSpeed : 2000,
			pre_loaded_data : null,	// if no data given then AJAX call ( for cookie )
			load_via : false		// ftp or local or database
		}, p);

		var news = {
			onsuccess: function(data){

				p.data = $.parseJSON(data);

				// setting controls
				p.start = 1;
				p.total_content = p.data.length;									// setting total contents length
	
				// building slider
				elements = this.buildSlider();
				$(this.filter).html(elements).css({'opacity':'0'});
				$(this.filter).stop().animate({'opacity':'1'}, 500);

				if(p.type != 'list'){
					// bydefault trigger first content
					$('a', this.filter).on('click',function(){
						news.changeContent($(this, this.filter));
					});
					this.populate($('a:first', this.filter));
				} else {
					$('.body', d).html(this.buildList()).find('.dataBox:last-child').addClass('last-child');	// last-child class for removing border of last child;
				}
				
				if(p.playAtStart){
					news.navigate('play');
				}
			},
			nextSlider: function(){
				if(p.current_content < p.total_content){
					$(this.data).html(this.overlay);
					if( p.current_content == (p.start + p.contents_per_page - 1) ){
						p.start += p.contents_per_page;

						p.old_data = $('a',this.filter);
						elements = this.buildSlider();
						width = $(this.filter).width()*2;

						var news_wrapper_width = $(this.filter).width();
						var news_item_width = (news_wrapper_width - 10)/3;
						$(this.filter).find('a').css('width', news_item_width);
						
						$(this.filter).width(width).append(elements).animate({left:'-=' + width/2},500,function(){
							$(p.old_data).remove();
							$(this).removeAttr('style');
						});
						$(this.filter).find('a').each(function(){
							$(this).css('width', news_item_width);
						});
					}
					this.populate( $( '#'+(p.current_content+1), this.filter ) );
				} else {
					if(p.autoplay == true){
						p.start = p.contents_per_page + 1;
						p.current_content = 2;
						this.prevSlider();
					}
				}
			},
			prevSlider: function(){
				if(p.current_content > 1){
					$(this.data).html(this.overlay);
					if(p.current_content == p.start || p.autoplay == true){
						p.start -= p.contents_per_page;

						p.old_data = $('a', this.filter);
						elements = this.buildSlider();
						width = $(this.filter).width()*2;

						$(this.filter).width(width).prepend(str).css({'left':-($('.data', d).width())}).animate({left:'+=' + (width/2)}, 500, function(){
							$(p.old_data).remove();
							$(this).removeAttr('style');
						});
					}
					this.populate( $( '#'+(p.current_content-1), this.filter ) );
				}
			},
			buildSlider : function(){
				if(p.total_content <= (p.start-1) + p.contents_per_page){
					end = p.total_content;
				} else {
					end = (p.start-1) + p.contents_per_page;
				}

				str = '';
				for(var i=(p.start-1); i<end; i++){
					 Title			= p.data[i]['Title']	? p.data[i]['Title']	: (p.data[i]['title']		? p.data[i]['title']:'');
					 ImageURL		= p.data[i]['ImageURL']	? p.data[i]['ImageURL']	: (p.data[i]['image_link']	? p.data[i]['image_link']:'');

				 	str +=  '<a id="' + (i + 1) + '">';
				  if(ImageURL != '#'){
					str +=  '<div class="ar-landscape-16-9"><img class="ar-img" src="' + ImageURL + '" alt="" height="75"/></div>' +
							'<p>' + Title + '</p>';
				  } else {
					str += Title;
				  }
					str += '</a>';
				}
				return str;
			},
			populate : function(target){
				p.current_content = parseInt($(target).attr('id'));

				$('a', this.filter).removeAttr('class');
				$(target, this.filter).addClass('active');

				this.buildRecord();
				this.buildPager();
			},
			buildList : function(){
				 if(p.data){

					 str = '';
					 $.each(p.data, function(index, data_extract){
						 WebLink		= data_extract['WebLink']		? data_extract['WebLink']		: (data_extract['link']			? data_extract['link']:'');
						 Title			= data_extract['Title']			? data_extract['Title']			: (data_extract['title']		? data_extract['title']:'');
						 ImageURL		= data_extract['ImageURL']		? data_extract['ImageURL']		: (data_extract['image_link']	? data_extract['image_link']:'');
						 FullText		= data_extract['FullText']		? data_extract['FullText']		: (data_extract['text']			? data_extract['text']:'');
			 
						str +=   '<div class="dataBox data">' +
									'<h3><a target="_blank" href="' + WebLink  + '">' + Title + '</a></h3>' +
									'<div class="record">';
							// if image is found
						  if(ImageURL != '#'){
							str +=  	'<div class="name">' +
											'<img src="' + ImageURL + '" alt="" />' +
										'</div>';
						  }
							str	+=  	'<div class="value">' + 
											FullText +
											'<a target="_blank" href="' + WebLink + '">Read more ...</a>' + 
										'</div>' +
									'</div>' +
								'</div>';
	
							$('.data', d).html(str).css({'opacity':'0'}).stop().animate({'opacity':'1'},500, function(){
								$(this).removeAttr('style');
							});
					 	});

					 return str;
					
				}
					 
				return false;
			},
			buildRecord : function(){
				$(this.data).html(this.loading);

				data_extract = p.data[p.current_content-1];
			 if(data_extract){

				 WebLink		= data_extract['WebLink']		? data_extract['WebLink']		: (data_extract['link']			? data_extract['link']:'');
				 Title			= data_extract['Title']			? data_extract['Title']			: (data_extract['title']		? data_extract['title']:'');
				 ImageURL		= data_extract['ImageURL']		? data_extract['ImageURL']		: (data_extract['image_link']	? data_extract['image_link']:'');
				 FullText		= data_extract['FullText']		? data_extract['FullText']		: (data_extract['text']			? data_extract['text']:'');
				 Description	= data_extract['Description']	? data_extract['Description']	: '';
				 
				str =   '<h3><a target="_blank" href="' + WebLink  + '">' + Title + '</a></h3>' +
						'<div class="record">';
				// if image is found
			  if(ImageURL != '#'){
				str +=  	'<div class="name">' +
								'<img src="' + ImageURL + '" alt="" />' +
							'</div>';
			  }
				str	+=  	'<div class="value">' + 
								FullText + Description +
								'<a target="_blank" href="' + WebLink + '">Read more ...</a>' + 
							'</div>' +
						'</div>';

				$('.data', d).html(str).find('.record:last-child').addClass('last-child');
				$('.data', d).css({'opacity':'0'}).stop().animate({'opacity':'1'},500, function(){
					$(this).removeAttr('style');
				});
			 }
			 
			 return str;
			},
			buildPager : function(){
				$(this.pager).html(parseInt(p.current_content) + ' / ' + parseInt(p.total_content));
				this.loading = false;
			},

			onerror: function(){},
			
			navigate: function(type){
				if(this.loading) return;
				this.loading = true;

				switch(type){
					case "next":
						this.stop();
						this.nextSlider();
						break;
					case "prev":
						this.stop();
						this.prevSlider();
						break;
					case "play":
						this.play();
						break;
					case "stop":
						this.stop();
						break;
				}				
				this.loading = false;
			},
			changeContent: function(target){
				if(this.loading) return;

				if(!$(target).hasClass('active')){
					this.loading = true;
					this.stop();
					$(this.data).html(this.overlay);

					this.populate(target);
				}
			},
			changeTab: function(target){
				if(this.loading) return;
				
				if(!$(target).hasClass('active')){
					$('.tab a', d).removeClass('active');
					news.navigate('stop');
/*
					if(p.playAtStart){
						p.playAtStart = false;
						news.navigate('play');
					}else {
						news.navigate('stop');
					}
*/					
					$(target).addClass('active');
					news.requestData($(target).attr('id'));
				}
			},
			requestData : function(target){

				if(this.loading == true) return;
				this.loading = true;
/*
				if(p.load_via == 'database'){
					$(this.data).html(this.overlay);
					rss_url = p.news_list['feed'][target]["rsspath"];
					category = p.news_list['feed'][target]['title'];
					proxy_timeout = p.news_list['default']["proxy_timeout"];
					url_data = (p.load_via ? "load_via=" + p.load_via + "&":'') + "category=" + category + "&rss_url=" + rss_url + "&proxy_timeout=" + proxy_timeout;
				} else { */
					rss_url = p.news_list['feed'][target]["rsspath"];
					category = p.news_list['feed'][target]['title'];
					ftp_proxy_url = p.ftp_proxy_url_segments + p.news_list['feed'][target]["proxypath"];
					http_proxy_url = p.proxy_url_base_path + p.news_list['feed'][target]["proxypath"];
					local_proxy_url = p.local_proxy_url + p.news_list['feed'][target]["proxypath"];
					proxy_timeout = p.news_list['default']["proxy_timeout"];
					url_data = "rss_url=" + rss_url + "&local_rss_path=" + local_proxy_url + "&ftp_rss_url=" + ftp_proxy_url + "&http_rss_url=" + http_proxy_url + "&proxy_timeout=" + proxy_timeout;
				/*}*/

				$.ajax({
					type: "POST",
					url: p.url,
					data: url_data,
					success: (function (data) {
						if(data){
							news.onsuccess(data);
						}else{
							news.onerror();
						}
					})
				});
			},
			play : function(){
				p.autoplay = true;

				this.play_handle = setInterval(function(){
					this.loading = true;
					news.nextSlider();
				}, p.playSpeed);
				
				$('#stop',d).css('display','inline-block');
				$('#play',d).css('display','none');
			},
			stop : function(){
				clearInterval(this.play_handle);
				p.autoplay = false;
				
				$('#play',d).css('display','inline-block');
				$('#stop',d).css('display','none');
			}
		};
		
		// build data
		news.data = document.createElement('div');
		news.data.className = 'data';
		$('.body', d).append(news.data);

		// loading
		news.overlay = document.createElement('div');
		news.overlay.className = 'loading';
		$(news.overlay).html('<img src="' + p.loadingImagePath + '" alt="loading..." title="loading">');
		$(news.data).append(news.overlay);
		
		if(p.type != 'list'){
			// build controls
			news.controller = document.createElement('div');
			news.controller.className = 'controls';
			$('.body', d).append(news.controller);
			// build filter
			news.filter = document.createElement('div');
			news.filter.className = 'filter';
			$(news.controller).append(news.filter);
//			news.filter = document.createElement('div');
//			news.filter.className = 'filter-wrapper';
			$(news.filter).wrap('<div class="filter-wrapper"></div>');
		} else {
/*	remaining task			
			news.requestData(p.title);
			str = '';
			for(i = 1; i < p.total_content ; i++){
				str += news.buildRecord();
				p.current_content++;
			}
*/			
		}

		// nav
		if(p.type == 'play'){
			news.controls = document.createElement('span');
			$(news.controls).append(
					'<a id="prev" title="previous"><img src="' + public_folder + 'images/theme/prev.png" alt="prev" /></a>' +
					'<a id="play" title="play"><img src="' + public_folder + 'images/theme/play-gray.png" alt="play" /></a>' +
					'<a id="stop" title="stop"><img src="' + public_folder + 'images/theme/stop-gray.png" alt="stop" /></a>' +
					'<a id="next" title="next"><img src="' + public_folder + 'images/theme/next.png" alt="next" /></a>'
			);
			$(news.controller).append(news.controls);
			$('a', news.controls).click(function(){
				news.navigate($(this).attr('id'));
			});
			
			// build pager
			news.pager = document.createElement('span');
			news.pager.className = 'paging';
			$('.filter', news.controller).after(news.pager);
		}

		$('.data a', d).on('click',function(){
			news.stop();
		});

		$('.tab a', d).click(function(){
			news.changeTab(this);
		});
		
		if(p.pre_loaded_data){ 

			if(p.pre_loaded_category){
				$('.tab a#' + p.pre_loaded_category, d).addClass('active');
			}
			news.loading = true;
			
			$(news.data).html(news.overlay);
			news.onsuccess(p.pre_loaded_data);
		} else {
			$('.tab a:first', d).trigger('click');
		}
		
		if(p.show_tabs == false){
			$('.tab', d).css('display','none');
		}
	};

	var docloaded = false;

	$(document).ready(function () {
		docloaded = true;
	});

	$.fn.customNews = function(p){
		return this.each(function () {
			if (!docloaded) {
				$(this).hide();
				var d = this;
				$(document).ready(function () {
					$.addNews(d, p);
				});
			} else {
				//console.log(d+" and "+p);
				$.addNews(this, p);
			}
		});
	};

})(jQuery);
/*====== NEWS V4 ENDS HERE ======*/


/*====== FINANCIALS V4 STARTS HERE ======*/
/* PLUGIN STARTS HERE */
( function ($) {
	$.addForex = function (d, p) {
		if (d.forex) return false;

		p = $.extend({
			exist_currency : new Array(),
			value_currency : 'USD',	// default ( but it changes to new currency on adding currency )
			forex_options  : '',	// this variable is not in use
			currency_counter : 0,
			
			cookie_name : 'dodear_ForEx',
			cookie_expire : 365,	// in days
			data_from_cookie : false,
			onSuccess : false,
			pre_loaded_data : null	// if no data given then AJAX call ( for cookie )
		}, p);

		var forex = {
			add: function(data){
        		currency= $.parseJSON(data);

				str_forex ='<div class="name">' + currency.CurrencyName + ' (' + currency.CurrencyID + ')</div>';
				str_forex +='<a id="' + currency.CurrencyID + '" class="close"></a>';
        		str_forex +='<div class="value">' + (Math.round(currency.Rate*100)/100).toFixed(2) + ' <span>PKR</span></div>';

            	$('.data #' + currency.CurrencyID, d).append(str_forex).css('display','block').addClass('record');
            	$('.data .record', d).removeClass('last-child');
            	$('.data .record:last-child', d).addClass('last-child');
            	
            	if (p.onSuccess) p.onSuccess();

			},
			deleteForex: function(target){
				p.current_currency = $(target).attr('id');
				var index = p.exist_currency.indexOf(p.current_currency);

				if (index !== -1) {
					p.exist_currency.splice(index, 1);
				}

				$(target).parent().remove();
				$('.data .record:last-child', d).addClass('last-child');
				
				if(p.onSuccess){ p.onSuccess(); }
			},
			getData: function(){
				if((p.value_currency != '') && (p.exist_currency.indexOf(p.value_currency) == -1)){
					p.exist_currency.push(p.value_currency);
					if(!p.data_from_cookie){
						forex.addCookie(p.value_currency);
					}

					$('.data', d).append('<div id="' + p.value_currency + '"></div>');
					
					$.ajax({
						type: "POST",
						url: site_url+"/en/financials/get_forex",
						data: "column="+p.value_currency,
						success: function(data){
			            	if(data){
			            		forex.add(data);
				            } else {
				            	value_currency = this.data.split('column=');
				            	value_currency = value_currency[1];
								$('.data #' + value_currency, d).remove();
							}
			            }
			        });
			    }
			},
			addCookie: function(new_data){
				// read data from cookie
				if(cookieData = forex.getCookie()){
					cookieData += ',' + new_data;	// adding new data
				} else {
					cookieData = new_data;
				}
				var date = new Date();
		        date.setTime(date.getTime() + (p.cookie_expire * 24 * 60 * 60 * 1000));
		        var expires = "; expires=" + date.toGMTString();
				
				document.cookie = escape(p.cookie_name) + "=" + escape(cookieData) + expires + "; path=/";
			},
			getCookie: function(){
			    var nameEQ = escape(p.cookie_name) + "=";
			    var ca = document.cookie.split(';');

			    for (var i = 0; i < ca.length; i++) {
			        var c = ca[i];
			        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
			        if (c.indexOf(nameEQ) == 0) return unescape(c.substring(nameEQ.length, c.length));
			    }
			    return null;
			},
			deleteCookie: function(data){
				cookieData = forex.getCookie();
				cookieData = cookieData.split(',');
				
				index = cookieData.indexOf(data);
				cookieData.splice(index, 1).join(',');
				
				var date = new Date();
		        date.setTime(date.getTime() + (p.cookie_expire * 24 * 60 * 60 * 1000));
		        var expires = "; expires=" + date.toGMTString();
				
				document.cookie = escape(p.cookie_name) + "=" + escape(cookieData) + expires + "; path=/";
			}
		};
		
		// add currency
		$('#forexRate_go', d).click(function(){
			if(p.currency_counter != 0){
				// if value from select is not empty
				if($('#forexRate').val() != ''){
					p.value_currency = $('#forexRate', d).val();
				}
				forex.getData();
			} else {	// first time load
				if(cookie_data = forex.getCookie()){	// if cookie
					cookie_data = cookie_data.split(',');
					p.data_from_cookie = true;
					for(i=0; i < cookie_data.length; i++){
						p.value_currency = cookie_data[i];
						forex.getData();
					}
					p.data_from_cookie = false;
				} else {	// if not cookie
					forex.getData();
				}
				p.currency_counter++;
			}

		});
		
		if(p.pre_loaded_data){
			p.currency_counter++;
			p.pre_loaded_data = $.parseJSON(p.pre_loaded_data);
			p.data_from_cookie = true;
			$.each(p.pre_loaded_data, function(index,data){

			p.value_currency = data.CurrencyID;

						if((p.value_currency != '') && (p.exist_currency.indexOf(p.value_currency) == -1)){
							p.exist_currency.push(p.value_currency);
							if(!p.data_from_cookie){
								forex.addCookie(p.value_currency);
							}
			
							$('.data', d).append('<div id="' + p.value_currency + '"></div>');
			            	
							if(data){
			            		forex.add(JSON.stringify(data));
				            } else {
				            	value_currency = this.data.split('column=');
				            	value_currency = value_currency[1];
								$('.data #' + value_currency, d).remove();
							}

					    }
			});
			p.data_from_cookie = false;
		} else {
			$('#forexRate_go', d).trigger('click');
		}

		// delete currency
		$(document).on('click', '#financials .close', function(){
			forex.deleteCookie($(this).attr('id'));
			forex.deleteForex($(this));
		});

	};

	var docloaded = false;

	$(document).ready(function () {
		docloaded = true;
	});

	$.fn.customForex = function(p){
		return this.each(function () {
			if (!docloaded) {
				$(this).hide();
				var d = this;
				$(document).ready(function () {
					$.addForex(d, p);
				});
			} else {
				$.addForex(this, p);
			}
		});
	};

})(jQuery);

/* plugin end */


$('#financials .tab a').click(function(){
	$('#financials .financials').css({'display':'none'});
	$('#financials .tab a').removeAttr('class');
	tabSelect = '#'+$(this).attr('id')+"_Container";
	$('#financials').find(tabSelect).css({'display':'block'});
	$(this).addClass('active');
	
	var fakeListener = setInterval(function(){
		if($('#financials .loading').length == 0){
	        clearInterval(fakeListener);
	        
	    	// adjust panel height
	    	//$('.content_height .pluginPanel').css('height','auto');
	    	//$('.content_height > .plugin').css('height','auto');
	    	//set_panel_height();
		}
	},50);
});

$(document).ready(function(){
	$('#financials .tab a:first').trigger('click');
	
	$('#fuelRates').click(function(){
		if($('#fuelRates_Container .record').length == 0){
			url = site_url+"/en/financials/get_fuels";
			type= 'fuels';
			container = 'fuelRates_Container';
			request_ajax_financials(url, type, container);
		}
	});
	$('#metalRates').click(function(){
		if($('#metalRates_Container .record').length == 0){
			url = site_url+"/en/financials/get_metals";
			type= 'metals';
			container = 'metalRates_Container';
			request_ajax_financials(url, type, container);
		}
	});
});

function request_ajax_financials(url, type, container){
	
	$('#' + container).html('<img class="loading" src="' + public_folder + 'images/loading/loading.gif" alt="loading ..." />');
	
	$.ajax({
		url: url, //site_url+"/en/financials/get_metals",
		dataType: 'json',
		type: 'POST',
		data: "AJAXRequest=true",
		success: function(data){

			if(data){
				var count = data.length;
				var rate_unit = (type == 'fuels') ? 'PKR / Litre' : 'PKR / 10gm';
				var str = '';
				$.each(data, function(){
					    count--;
					    last_record = (count == 0) ? 'lastRecord ' : '';
						str +=	'<div class="' + last_record + 'record">' +
									'<div class="name">' + this.ItemName + '</div>' +
									'<div class="value">' + this.Rate + ' <span>' + rate_unit + '</span></div>' +
								'</div>';
				});

				$('#' + container).html(str);
			}
		}
	});
}
/*====== FINANCIALS V4 ENDS HERE ======*/


/*====== HOROSCOPE V4 STARTS HERE ======*/
/* PLUGIN STARTS HERE */
( function ($) {
	$.addHoroscope = function (d, p) {
		if (d.horoscope) return false;

		p = $.extend({
			// containers
			title : 'Horoscope',
			imgpath : public_folder + 'images/icons/horoscope/30x30/',
			thumbpath : public_folder + 'images/icons/horoscope/90x90/',
			loadingImgPath : public_folder + 'images/loading/loading.gif',
			index : 0,
			list_loaded : false,
			body_height : 0,
			
			proxy_url_base_path : 'http://',
			
			cookie_name : 'dodear_Horoscope',
			cookie_expire : 365,	// in days
			pre_loaded_data : null	// if no data given then AJAX call ( for cookie )
		}, p);

		var horoscope = {
			addData: function (data) {
				this.loading = false;
				$('.loading', d).css({'display':'none'});
				$(horoscope.body, d).css('height', p.body_height);

				data = $.parseJSON(data);
				$.each(data, function(index, row) {
					h_title = p.horoscope_list['feed'][(p.index-1)]['title'];
					str =	'<div class="name">' +
								'<img src="' + p.thumbpath + h_title.toLowerCase() + '.png" alt="' + h_title + '" />' +
								'<h3>' + h_title + '</h3>' +
								'(' + p.horoscope_list['feed'][(p.index-1)]['start_date'] + ' - ' + p.horoscope_list['feed'][(p.index-1)]['end_date'] + ')' +
							'</div>' +
							'<div class="value">' + row.text + '</div>';
				});
				
				$('.record', d).html(str);
				
				var record_timer = setInterval(function(){
					$('.record', d).css('display','block');
					if($('.record', d).css('display') == 'block'){
						clearInterval(record_timer);
					}
				}, 50);
				
				$('.tab', d).css('display', 'block');

			},
			onError: function (data) {},
			changePage: function(ctype) {
				if(this.loading) return true;
				if(ctype == 'prev' && p.index > 1){
					horoscope.requestData(p.index-1);
				}else if(ctype == 'next' && p.index < 12){
					horoscope.requestData(parseInt(p.index)+1);
				}
				return false;
			},
			requestData: function(id) {

				status = parseInt(p.horoscope_list['feed'][(id - 1)]["status"] ? p.horoscope_list['feed'][(id - 1)]["status"] : 1);

				if(parseInt(status) == 0){
					p.index = id;
					return false;
				}
				
				this.request_data_pre_requisite();
				
				p.index = id;
				
				rss_url = p.horoscope_list['feed'][(p.index-1)]["rsspath"];
				ftp_proxy_url = p.horoscope_list['feed'][(p.index-1)]["proxypath"];
				http_proxy_url = p.proxy_url_base_path + p.horoscope_list['feed'][(p.index-1)]["proxypath"];
				//file_name = p.horoscope_list['feed'][(p.index-1)]["proxypath"].split(/[\/]+/).pop();
				local_proxy_url = p.local_proxy_url + p.horoscope_list['feed'][(p.index-1)]["proxypath"];
				//proxy_timeout = p.horoscope_list['feed'][(p.index-1)]["proxy_timeout"];
				proxy_timeout = p.horoscope_list['default']["proxy_timeout"];

				$.ajax({
					type: "POST",
					url: p.url,
					data: "rss_url=" + rss_url + "&local_rss_path=" + local_proxy_url + "&ftp_rss_url=" + ftp_proxy_url + "&http_rss_url=" + http_proxy_url + "&proxy_timeout=" + proxy_timeout,
					success: function(data){
						if(data){
							horoscope.addData(data);
						}
					}
				});
			},
			request_data_pre_requisite: function(){
				if(this.loading) return true;
				this.loading = true;
				
				$(horoscope.body, d).css('height', (parseInt($(d).css('height')) - (parseInt($(horoscope.head, d).css('height'))  + ($(horoscope.body, d).outerHeight() - parseInt($(horoscope.body, d).height())))) + 'px');
				$('.loading', d).css({'display':'block'});
				$('.filter, .record', d).css({'display':'none'});
			},
			createList: function(){
				if(this.loading) return true;
				
				
				
				if(p.list_loaded == false){
					str = '';
					$.each(p.horoscope_list['feed'], function(index, row){
						str +=	'<a id="' + (index+1) + '">' +
									'<span><img src="' + p.imgpath + row['title'].toLowerCase() + '.png" alt="' + row['title'] + '" /></span>' + row['title'] +
								'</a>';
					});
					$('.filter', d).html(str);
					$('.filter a', d).on('click',function(){
						id = $(this).attr('id');
						horoscope.requestData(parseInt(id));
						horoscope.addCookie($(this).attr('id'));

					});

					p.list_loaded = true;
				}

//				p.index = 0;

				$('.tab', d).css('display','none');
				$('.filter', d).css('display','block');
				timer = setTimeout(function(){
					if($(".filter a:last-child").is(":visible")){
						$('.loading', d).css('display','none');
						$(horoscope.body, d).css('height', (parseInt($(d).css('height')) - (parseInt($(horoscope.head, d).css('height'))  + ($(horoscope.body, d).outerHeight() - parseInt($(horoscope.body, d).height())))) + 'px');
						$('.record', d).css('display','none');
						clearTimeout(timer);
					}
				},50);
			},
			addCookie: function(new_data){

				var date = new Date();
		        date.setTime(date.getTime() + (p.cookie_expire * 24 * 60 * 60 * 1000));
		        var expires = "; expires=" + date.toGMTString();
				
				document.cookie = escape(p.cookie_name) + "=" + escape(new_data) + expires + "; path=/";
			},
			getCookie: function(){
			    var nameEQ = escape(p.cookie_name) + "=";
			    var ca = document.cookie.split(';');

			    for (var i = 0; i < ca.length; i++) {
			        var c = ca[i];
			        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
			        if (c.indexOf(nameEQ) == 0) return unescape(c.substring(nameEQ.length, c.length));
			    }
			    return null;
			}
		};

		horoscope.head = document.createElement('div');
		horoscope.head.className = 'head';
		
		$(horoscope.head).append('<h2>' + p.title + '</h2>');
		
		horoscope.tab = document.createElement('div');
		horoscope.tab.className = 'tab';
		$(horoscope.tab).append('<a class="prev">Prev</a> / <a class="next">Next</a> / <a class="list">Horoscope List</a>');
		$(horoscope.head).append(horoscope.tab);
		$(d).append(horoscope.head);
		
		horoscope.body = document.createElement('div');
		horoscope.body.className = 'body';
		
		horoscope.data = document.createElement('div');
		horoscope.data.className = 'data';
		$(horoscope.body).append(horoscope.data);
		$(d).append(horoscope.body);

		p.body_height = parseInt($(d).css('height')) - (parseInt($(horoscope.head, d).css('height')) + parseInt($(horoscope.body, d).css('border-top-width')) + parseInt($(horoscope.body, d).css('border-bottom-width')) + parseInt($(horoscope.body, d).css('padding-top')) + parseInt($(horoscope.body, d).css('padding-bottom'))) + 'px';
		
		/* Horoscope Code Buildup Start Here */
		$('.data', d).html(	'<div class="filter" style="display:none;"></div>' +
							'<div class="loading"><img title="loading" alt="loading..." src="' + p.loadingImgPath + '"></div>' +
							'<div class="record"></div>');

		$('.prev', d).click(function () {
			status = horoscope.changePage('prev');
			if(status == 'false' && ((horoscope_id = parseInt(horoscope.getCookie())) > 1)){
				horoscope.addCookie(horoscope_id - 1);
			}
		});
		$('.next', d).click(function () {
			status = horoscope.changePage('next');
			if(status == 'false' && ((horoscope_id = parseInt(horoscope.getCookie())) < 12)){
				horoscope.addCookie(horoscope_id + 1);
			}
		});
		$('.list', d).click(function () {
			$(horoscope.body, d).css('height', (parseInt($(d).css('height')) - (parseInt($(horoscope.head, d).css('height'))  + ($(horoscope.body, d).outerHeight() - parseInt($(horoscope.body, d).height())))) + 'px');
			horoscope.createList();
			horoscope.addCookie(null);
			
		});

		horoscope.createList();

		if(p.pre_loaded_data && (p.index != 'null' || p.index != 0)){
			horoscope.request_data_pre_requisite();
			horoscope.addData(p.pre_loaded_data);
		} else if(id = horoscope.getCookie()){

			horoscope_anc = $('.filter a',d);
			$(horoscope_anc[id - 1]).trigger('click');
		}
	};

	var docloaded = false;

	$(document).ready(function () {
		docloaded = true;
	});

	$.fn.customHoroscope = function(p){
		return this.each(function () {
			if (!docloaded) {
				$(this).hide();
				var d = this;
				$(document).ready(function () {
					$.addHoroscope(d, p);
				});
			} else {
				$.addHoroscope(this, p);
			}
		});
	};

})(jQuery);
/*====== HOROSCOPE V4 ENDS HERE ======*/


/*====== WEATHER V4 STARTS HERE ======*/
/* PLUGIN STARTS HERE */
( function ($) {
	$.addWeather = function (d, p) {
		if (d.weather) return false;

		p = $.extend({
				exist_city :  new Array(),
				value_city : 'PKXX0008',	// default ( but it changes to new currency on adding currency )
				weather_counter : 0,
				
				proxy_url_base_path : 'http://',
				
				cookie_name : 'dodear_Weather',
				cookie_expire : 365,	// in days
				data_from_cookie : false,
				pre_loaded_data : null	// if no data given then AJAX call ( for cookie )
		}, p);

		var weather = {
				onSuccess : function(data){
					weatherData = jQuery.parseJSON(data);
					
					value_city = weatherData.value_city;
					str='<a id="' + value_city + '" class="close"></a>' +
						'<a href="' + weatherData[0] + '" target="_blank">' + weatherData[1] + '</a>' +
						'<div class="value">' +
							'<img align="left" src="' + weatherData[2] + '" alt="" />' + weatherData[3] +
						'</div>';
					$('.data #' + value_city, d).append(str).addClass('record');
					$('.data .record', d).removeClass('last-child');
					$('.data .record:last-child', d).addClass('last-child');
					
					if(p.onSuccess){ p.onSuccess(); }
				},
				deleteData : function(target){

					p.current_city = $(target).attr('id');
					var index = p.exist_city.indexOf(p.current_city); 
					   
					if (index !== -1) {
						p.exist_city.splice(index, 1);
					}
					
					$(target).parent().remove();
					$('.data .record:last-child', d).addClass('last-child');
					
					if(p.onSuccess){ p.onSuccess(); }
				},
				addData : function(){
					status = parseInt(p.weather_list['feed'][(p.value_city)]["status"] ? p.weather_list['feed'][(p.value_city)]["status"] : 1);

					if(parseInt(status) == 0){
						return false;
					}
					
					if((p.value_city != '') && (p.exist_city.indexOf(p.value_city) == -1)){
						p.exist_city.push(p.value_city);

						if(!p.data_from_cookie){
							weather.addCookie(p.value_city);
						}
						
						rss_url = p.weather_list['feed'][p.value_city]["rsspath"]; 
						rss_url = encodeURIComponent(rss_url);
						ftp_proxy_url = p.weather_list['feed'][p.value_city]["proxypath"];
						http_proxy_url = p.proxy_url_base_path + p.weather_list['feed'][p.value_city]["proxypath"];
						file_name = p.weather_list['feed'][p.value_city]["proxypath"].split(/[\/]+/).pop();
						//local_proxy_url = p.local_proxy_url + file_name;
						local_proxy_url = p.local_proxy_url + p.weather_list['feed'][p.value_city]["proxypath"];
						proxy_timeout = p.weather_list['default']["proxy_timeout"];
						
						$('.data', d).append('<div id="' + p.value_city + '"></div>');
						
						$.ajax({
							type: "POST",
							url: p.url,
							data: "rss_url=" + rss_url + "&local_rss_path=" + local_proxy_url + "&ftp_rss_url=" + ftp_proxy_url + "&http_rss_url=" + http_proxy_url + "&proxy_timeout=" + proxy_timeout + '&value_city=' + p.value_city,
							success: function(data){
								if(data){
									weather.onSuccess(data);
								} else {
									value_city = this.data.split('value_city=');
									value_city = value_city[1];
									$('.data #' + value_city, d).remove();
								}
							}
						});
					}
					p.weather_counter++;
				},
				addCookie: function(new_data){
					// read data from cookie
					if(cookieData = weather.getCookie()){
						cookieData += ',' + new_data;	// adding new data
					} else {
						cookieData = new_data;
					}
					var date = new Date();
			        date.setTime(date.getTime() + (p.cookie_expire * 24 * 60 * 60 * 1000));
			        var expires = "; expires=" + date.toGMTString();
					
					document.cookie = escape(p.cookie_name) + "=" + escape(cookieData) + expires + "; path=/";
				},
				getCookie: function(){
				    var nameEQ = escape(p.cookie_name) + "=";
				    var ca = document.cookie.split(';');

				    for (var i = 0; i < ca.length; i++) {
				        var c = ca[i];
				        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
				        if (c.indexOf(nameEQ) == 0) return unescape(c.substring(nameEQ.length, c.length));
				    }
				    return null;
				},
				deleteCookie: function(data){
					cookieData = weather.getCookie();
					cookieData = cookieData.split(',');
					
					index = cookieData.indexOf(data);
					cookieData.splice(index, 1).join(',');
					
					var date = new Date();
			        date.setTime(date.getTime() + (p.cookie_expire * 24 * 60 * 60 * 1000));
			        var expires = "; expires=" + date.toGMTString();
					
					document.cookie = escape(p.cookie_name) + "=" + escape(cookieData) + expires + "; path=/";
				}
		};
		
		
		
		// build body
		weather.body = document.createElement('div');
		weather.body.className = 'body';
		// build data
		weather.data = document.createElement('div');
		weather.data.className = 'data';
		$(weather.body).append(weather.data);
		// build filter
		weather.filter = document.createElement('div');
		weather.filter.className = 'filter';
		$(weather.body).append(weather.filter);
		
		str = '';
		$.each(p.weather_list['feed'], function($index, $row){
			if($row['status'] != "0"){
				str += '<option value="' + $index + '">' + $row['title'] + '</option>';
			};
		});
		$(weather.filter).append('<form name="form_weather" action="">' +
							  	 	'<select name="weather_city" id="weather_city">' +
							  	 		'<option value="" selected>-- Select City --</option>' +
					  					str +
					  				'</select>' +
					  				'<input class="button" id="go" type="button" value="+" />' +
								 '</form>');
		
		$(d).append(weather.body);
		
		// add weather
		$("#go", d).click(function(){
			
			if(p.weather_counter != 0){
				// if value from select is not empty
				if($('#weather_city').val() != ''){
					p.value_city = $('#weather_city', d).val();
				}
				weather.addData();
			} else {	// first time load
				if(cookie_data = weather.getCookie()){	// if cookie
					cookie_data = cookie_data.split(',');
					p.data_from_cookie = true;
					for(i=0; i < cookie_data.length; i++){
						p.value_city = cookie_data[i];
						weather.addData();
					}
					p.data_from_cookie = false;
				} else {	// if not cookie
					for(i=0; i<p.weather_startup_list.length; i++){
						p.value_city = p.weather_startup_list[i];
						weather.addData();	
					}
				}

				p.weather_counter++;
			}

		});
		
		// delete weather
		$('.close', d).live('click',function(){
			weather.deleteCookie($(this).attr('id'));
			weather.deleteData($(this));			
		});
		
		if(p.pre_loaded_data){

			p.weather_counter++;

			//p.pre_loaded_data = $.parseJSON(p.pre_loaded_data);
			p.data_from_cookie = true;
			
			$.each(p.pre_loaded_data, function(index,data){
			p.value_city = data['value_city'];

						if((p.value_city != '') && (p.exist_city.indexOf(p.value_city) == -1)){
							p.exist_city.push(p.value_city);
							if(!p.data_from_cookie){
								weather.addCookie(p.value_city);
							}
			
							$('.data', d).append('<div id="' + p.value_city + '"></div>');
			            	
							if(data){
			            		weather.onSuccess(JSON.stringify(data));
				            } else {
								value_city = this.data.split('value_city=');
								value_city = value_city[1];
								$('.data #' + value_city, d).remove();
							}

					    }
			});
			p.data_from_cookie = false;
		} else {
			// trigger click on page load		
			$('#go', d).trigger('click');
		}
	};

	var docloaded = false;

	$(document).ready(function () {
		docloaded = true;
	});

	$.fn.customWeather = function(p){
		return this.each(function () {
			if (!docloaded) {
				$(this).hide();
				var d = this;
				$(document).ready(function () {
					$.addWeather(d, p);
				});
			} else {
				$.addWeather(this, p);
			}
		});
	};

})(jQuery);
/*====== WEATHER V4 ENDS HERE ======*/
